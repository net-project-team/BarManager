@page "/productcart"
@using Manager.Application.Handlers;
@using Manager.Infrastructure.Repositories.Models;
@using Manager.Application.Handler.Interfaces;
@using Manager.Application.Repository.Interfaces;
@using Manager.Domain.Models;
@inject IJSRuntime JSRuntime;

    <button style="width:170px;height:70px;" class="btn btn-success" @onclick="@(() => addNewOrder())">New Order</button>
    
<div class="row">

    
    @if (showCategories)
    {
         <div style = "width:200px; height:auto;" class="col-sm-5">
            @foreach (Category category in categories)
            {
                <div style="width:150px;padding:10px;" class="row"><button class="btn btn-secondary btn-sm"  onclick="@(() => ChoosedCategory(category))">@category.CategoryName</button></div>

            }

            </div>
    }
    @if (products != null)
    {
        <div  class="col">
            <div class="flextest">

                @foreach (Product product in products)
                {

                    <div> <button style="width:100px;height:100px" class="btn btn-success" onclick="@(() => ChoosedProduct(product))">@product.ProductName</button></div>

                }

            </div>
            

            
           
        </div>


    }
    <div style="width:400px;height:600px; overflow-y: auto;">
        @if (choosedProducts != null)
        {
            @foreach (Product product in choosedProducts)
            {
                <table class="table">
                    <thead>
                        <tr>
                            <td>@product.ProductName</td>
                            <td> <button class="btn btn-danger" onclick="@(() =>RemoveFirstProduct(product))">Remove</button></td>
                        </tr>
                    </thead>

                </table>

            }

        }
               

    </div>
    <div style="float:inline-end"><h2>TotalSum:@TotalSum</h2></div>
    <button style="width:170px;height:70px;" class="btn btn-danger" @onclick="(()=>CheckoutBtn())">Checkout</button>
    @if (showAlert)
    {
        <div class="alert alert-success" id="myAlert" @style="alertStyle">
            <strong>Succsess!</strong>
        </div>

    }
    
</div>



@code {
    List<OrderProduct> orderProductList = new List<OrderProduct>();
    bool showCategories = false;


    int insertedOrderId = 0;
    public async void addNewOrder()
    {
        showCategories = true;
        Order order = new Order();
        order.OrderTable = 1;
        insertedOrderId = await new OrdersRepo().InsertOrderReturnId(order);
        


    }

    List<Category> categories = new List<Category>();

    List<Product> choosedProducts = new List<Product>();
    protected override async Task OnInitializedAsync()
    {
        ICategoryRepository categoryRepository = new CategoryRepo();
        ICategoryHandler categoryhandler = new CategoryHandler(categoryRepository);

        categories = await categoryhandler.GetAllCategoriesAsync();

    }
  
    List<Product> products;
    decimal TotalSum = 0;
    public async void ChoosedCategory(Category category)
    {
        ProductsRepo productsRepo = new ProductsRepo();
       
        products = await productsRepo.GetAllGroupCategoryAsync(category.CategoryID);

        StateHasChanged();

    }

    void RemoveFirstProduct(Product product)
    {
        if (choosedProducts.Count > 0)
        {
            OrderProduct forRemove = new OrderProduct()
            {
                Product = product
            };
            choosedProducts.Remove(product);

            orderProductList.Remove(orderProductList.Find(x => x.Product == product));

            TotalSum -= product.ProductPrice;
        }
        StateHasChanged();
    }




    public void ChoosedProduct(Product product)
    {
        choosedProducts.Add(product);
        TotalSum += product.ProductPrice;
        Order choosedOrder = new()
            {
                OrderId = insertedOrderId,
                OrderTable = 1
            };

        orderProductList.Add(new OrderProduct()
            {
                Order = choosedOrder,
                Product = product

        });


        StateHasChanged();
    }
    bool showAlert = false;

    public async void CheckoutBtn()
    {
        
        await new OrderProductsRepo().InsertRangeAsync(orderProductList);
        orderProductList = new List<OrderProduct>();
        choosedProducts = new List<Product>();
        products = null;
        showCategories = false;
        TotalSum = 0;
      
        insertedOrderId = 0;
        await ShowAlertWithTimer();
        StateHasChanged();
        

    }
    
    private async Task ShowAlertWithTimer()
    {
        showAlert = true; 
        StateHasChanged();

        await Task.Delay(1000);

        showAlert = false; 
        StateHasChanged(); 
    }
}
